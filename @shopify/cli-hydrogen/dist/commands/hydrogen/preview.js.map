{"version":3,"file":"preview.js","sources":["../../../src/cli/services/preview.ts","../../../src/cli/commands/hydrogen/preview.ts"],"sourcesContent":["import {path, error, system, file} from '@shopify/cli-kit'\nimport {fileURLToPath} from 'url'\n\ninterface PreviewOptions {\n  directory: string\n  port: number\n}\n\nasync function preview({directory, port}: PreviewOptions) {\n  const config = {\n    port,\n    workerFile: 'dist/worker/index.js',\n    assetsDir: 'dist/client',\n    buildCommand: 'yarn build',\n    modules: true,\n    watch: true,\n    buildWatchPaths: ['./src'],\n    autoReload: true,\n  }\n\n  await file.write(path.resolve(directory, 'mini-oxygen.config.json'), JSON.stringify(config, null, 2))\n\n  function cleanUp(options: {exit: boolean}) {\n    if (options.exit) {\n      file.remove(path.resolve(directory, 'mini-oxygen.config.json'))\n    }\n  }\n\n  process.on('SIGINT', cleanUp.bind(null, {exit: true}))\n\n  const executable = await oxygenPreviewExecutable()\n\n  await system.exec(executable, [], {\n    env: {NODE_OPTIONS: '--experimental-vm-modules'},\n    cwd: directory,\n    stdout: process.stdout,\n  })\n}\n\nexport default preview\n\nexport const OxygenPreviewExecutableNotFound = new error.Abort(\n  'Could not locate the executable file to run Oxygen locally.',\n)\n\nasync function oxygenPreviewExecutable(): Promise<string> {\n  const cwd = path.dirname(fileURLToPath(import.meta.url))\n  const executablePath = await path.findUp('node_modules/.bin/oxygen-preview', {type: 'file', cwd})\n  if (!executablePath) {\n    throw OxygenPreviewExecutableNotFound\n  }\n  return executablePath\n}\n","import previewService from '../../services/preview'\nimport {path} from '@shopify/cli-kit'\nimport {Command, Flags} from '@oclif/core'\n\nexport default class Preview extends Command {\n  static description = 'Run a Hydrogen storefront locally in a worker environment'\n  static flags = {\n    path: Flags.string({\n      hidden: true,\n      description: 'the path to your hydrogen storefront',\n      env: 'SHOPIFY_FLAG_PATH',\n    }),\n    port: Flags.string({\n      char: 'p',\n      hidden: true,\n      description: 'the port to run the preview server on',\n      default: '3000',\n      env: 'SHOPIFY_FLAG_PORT',\n    }),\n  }\n\n  async run(): Promise<void> {\n    const {flags} = await this.parse(Preview)\n    const directory = flags.path ? path.resolve(flags.path) : process.cwd()\n    const port = parseInt(flags.port, 10)\n\n    await previewService({directory, port})\n  }\n}\n"],"names":["previewService"],"mappings":"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"}